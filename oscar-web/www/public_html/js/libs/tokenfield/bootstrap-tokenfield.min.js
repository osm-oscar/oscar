(function(c){"function"===typeof define&&define.amd?define(["jquery"],c):"object"===typeof exports?module.exports=global.window&&global.window.$?c(global.window.$):function(h){if(!h.$&&!h.fn)throw Error("Tokenfield requires a window object with jQuery or a jQuery instance");return c(h.$||h)}:c(jQuery,window)})(function(c,h){var l=function(a,b){var e=this;this.$element=c(a);this.textDirection=this.$element.css("direction");this.options=c.extend(!0,{},c.fn.tokenfield.defaults,{tokens:this.$element.val()},
this.$element.data(),b);this._delimiters="string"===typeof this.options.delimiter?[this.options.delimiter]:this.options.delimiter;this._triggerKeys=c.map(this._delimiters,function(a){return a.charCodeAt(0)});this._firstDelimiter=this._delimiters[0];var d=c.inArray(" ",this._delimiters),f=c.inArray("-",this._delimiters);0<=d&&(this._delimiters[d]="\\s");0<=f&&(delete this._delimiters[f],this._delimiters.unshift("-"));var k="\\$[{^.|?*+()".split("");c.each(this._delimiters,function(a,b){0<=c.inArray(b,
k)&&(e._delimiters[a]="\\"+b)});var g=h&&"function"===typeof h.getMatchedCSSRules?h.getMatchedCSSRules(a):null,d=a.style.width,l,f=this.$element.width();g&&c.each(g,function(a,b){b.style.width&&(l=b.style.width)});var g="rtl"===c("body").css("direction")?"right":"left",m={position:this.$element.css("position")};m[g]=this.$element.css(g);this.$element.data("original-styles",m).data("original-tabindex",this.$element.prop("tabindex")).css("position","absolute").css(g,"-10000px").prop("tabindex",-1);
this.$wrapper=c('<div class="tokenfield form-control" />');this.$element.hasClass("input-lg")&&this.$wrapper.addClass("input-lg");this.$element.hasClass("input-sm")&&this.$wrapper.addClass("input-sm");"rtl"===this.textDirection&&this.$wrapper.addClass("rtl");m=this.$element.prop("id")||(new Date).getTime()+""+Math.floor(100*(1+Math.random()));this.$input=c('<input type="'+this.options.inputType+'" class="token-input" autocomplete="off" />').appendTo(this.$wrapper).prop("placeholder",this.$element.prop("placeholder")).prop("id",
m+"-tokenfield").prop("tabindex",this.$element.data("original-tabindex"));m=c('label[for="'+this.$element.prop("id")+'"]');m.length&&m.prop("for",this.$input.prop("id"));this.$copyHelper=c('<input type="text" />').css("position","absolute").css(g,"-10000px").prop("tabindex",-1).prependTo(this.$wrapper);d?this.$wrapper.css("width",d):l?this.$wrapper.css("width",l):this.$element.parents(".form-inline").length&&this.$wrapper.width(f);(this.$element.prop("disabled")||this.$element.parents("fieldset[disabled]").length)&&
this.disable();this.$element.prop("readonly")&&this.readonly();this.$mirror=c('<span style="position:absolute; top:-999px; left:0; white-space:pre;"/>');this.$input.css("min-width",this.options.minWidth+"px");c.each("fontFamily fontSize fontWeight fontStyle letterSpacing textTransform wordSpacing textIndent".split(" "),function(a,b){e.$mirror[0].style[b]=e.$input.css(b)});this.$mirror.appendTo("body");this.$wrapper.insertBefore(this.$element);this.$element.prependTo(this.$wrapper);this.update();this.setTokens(this.options.tokens,
!1,!this.$element.val()&&this.options.tokens);this.listen();c.isEmptyObject(this.options.autocomplete)||(d="rtl"===this.textDirection?"right":"left",d=c.extend({minLength:this.options.showAutocompleteOnFocus?0:null,position:{my:d+" top",at:d+" bottom",of:this.$wrapper}},this.options.autocomplete),this.$input.autocomplete(d));c.isEmptyObject(this.options.typeahead)||(f=this.options.typeahead,d={minLength:this.options.showAutocompleteOnFocus?0:null},f=c.isArray(f)?f:[f,f],f[0]=c.extend({},d,f[0]),this.$input.typeahead.apply(this.$input,
f),this.$hint=this.$input.prev(".tt-hint"),this.typeahead=!0)};l.prototype={constructor:l,createToken:function(a,b){var e=this;a="string"===typeof a?{value:a,label:a}:c.extend({},a);"undefined"===typeof b&&(b=!0);a.value=c.trim(a.value.toString());a.label=a.label&&a.label.length?c.trim(a.label):a.value;if(!(!a.value.length||!a.label.length||a.label.length<=this.options.minLength||this.options.limit&&this.getTokens().length>=this.options.limit)){var d=c.Event("tokenfield:createtoken",{attrs:a});this.$element.trigger(d);
if(d.attrs&&!d.isDefaultPrevented()){var f=c('<div class="token" />').append('<span class="token-label" />').append('<a href="#" class="close" tabindex="-1">&times;</a>').data("attrs",a);this.$input.hasClass("tt-input")?this.$input.parent().before(f):this.$input.before(f);this.$input.css("width",this.options.minWidth+"px");var d=f.find(".token-label"),k=f.find(".close");this.maxTokenWidth||(this.maxTokenWidth=this.$wrapper.width()-k.outerWidth()-parseInt(k.css("margin-left"),10)-parseInt(k.css("margin-right"),
10)-parseInt(f.css("border-left-width"),10)-parseInt(f.css("border-right-width"),10)-parseInt(f.css("padding-left"),10)-parseInt(f.css("padding-right"),10),parseInt(d.css("border-left-width"),10)-parseInt(d.css("border-right-width"),10)-parseInt(d.css("padding-left"),10)-parseInt(d.css("padding-right"),10),parseInt(d.css("margin-left"),10)-parseInt(d.css("margin-right"),10));d.text(a.label).css("max-width",this.maxTokenWidth);f.on("mousedown",function(a){if(e._disabled||e._readonly)return!1;e.preventDeactivation=
!0}).on("click",function(a){if(e._disabled||e._readonly)return!1;e.preventDeactivation=!1;if(a.ctrlKey||a.metaKey)return a.preventDefault(),e.toggle(f);e.activate(f,a.shiftKey,a.shiftKey)}).on("dblclick",function(a){if(e._disabled||e._readonly||!e.options.allowEditing)return!1;e.edit(f)});k.on("click",c.proxy(this.remove,this));this.$element.trigger(c.Event("tokenfield:createdtoken",{attrs:a,relatedTarget:f.get(0)}));b&&this.$element.val(this.getTokensList()).trigger(c.Event("change",{initiator:"tokenfield"}));
this.update();return this.$element.get(0)}}},setTokens:function(a,b,e){if(a){b||this.$wrapper.find(".token").remove();"undefined"===typeof e&&(e=!0);"string"===typeof a&&(a=this._delimiters.length?a.split(new RegExp("["+this._delimiters.join("")+"]")):[a]);var d=this;c.each(a,function(a,b){d.createToken(b,e)});return this.$element.get(0)}},getTokenData:function(a){a=a.map(function(){return c(this).data("attrs")}).get();1==a.length&&(a=a[0]);return a},getTokens:function(a){var b=this,e=[];this.$wrapper.find(".token"+
(a?".active":"")).each(function(){e.push(b.getTokenData(c(this)))});return e},getTokensList:function(a,b,e){a=" ";b="undefined"!==typeof b&&null!==b?b:this.options.beautify;a+=b&&" "!==a?" ":"";return c.map(this.getTokens(e),function(a){return a.value}).join(a)},getInput:function(){return this.$input.val()},listen:function(){var a=this;this.$element.on("change",c.proxy(this.change,this));this.$wrapper.on("mousedown",c.proxy(this.focusInput,this));this.$input.on("focus",c.proxy(this.focus,this)).on("blur",
c.proxy(this.blur,this)).on("paste",c.proxy(this.paste,this)).on("keydown",c.proxy(this.keydown,this)).on("keypress",c.proxy(this.keypress,this)).on("keyup",c.proxy(this.keyup,this));this.$copyHelper.on("focus",c.proxy(this.focus,this)).on("blur",c.proxy(this.blur,this)).on("keydown",c.proxy(this.keydown,this)).on("keyup",c.proxy(this.keyup,this));this.$input.on("keypress",c.proxy(this.update,this)).on("keyup",c.proxy(this.update,this));this.$input.on("autocompletecreate",function(){var b=c(this).data("ui-autocomplete").menu.element,
e=a.$wrapper.outerWidth()-parseInt(b.css("border-left-width"),10)-parseInt(b.css("border-right-width"),10);b.css("min-width",e+"px")}).on("autocompleteselect",function(b,c){a.createToken(c.item)&&(a.$input.val(""),a.$input.data("edit")&&a.unedit(!0));return!1}).on("typeahead:selected typeahead:autocompleted",function(b,c,d){a.createToken(c)&&(a.$input.typeahead("val",""),a.$input.data("edit")&&a.unedit(!0))});c(h).on("resize",c.proxy(this.update,this))},keydown:function(a){function b(b){d.$input.is(document.activeElement)?
0<d.$input.val().length||(b+="All",b=d.$input.hasClass("tt-input")?d.$input.parent()[b](".token:first"):d.$input[b](".token:first"),b.length&&(d.preventInputFocus=!0,d.preventDeactivation=!0,d.activate(b),a.preventDefault())):(d[b](a.shiftKey),a.preventDefault())}function e(b){if(a.shiftKey){if(d.$input.is(document.activeElement)){if(0<d.$input.val().length)return;var e=d.$input.hasClass("tt-input")?d.$input.parent()[b+"All"](".token:first"):d.$input[b+"All"](".token:first");if(!e.length)return;d.activate(e)}e=
"prev"===b?"first":"last";d.$firstActiveToken[("prev"===b?"next":"prev")+"All"](".token").each(function(){d.deactivate(c(this))});d.activate(d.$wrapper.find(".token:"+e),!0,!0);a.preventDefault()}}if(this.focused){var d=this;switch(a.keyCode){case 8:if(!this.$input.is(document.activeElement))break;this.lastInputValue=this.$input.val();break;case 37:b("rtl"===this.textDirection?"next":"prev");break;case 38:e("prev");break;case 39:b("rtl"===this.textDirection?"prev":"next");break;case 40:e("next");
break;case 65:if(0<this.$input.val().length||!a.ctrlKey&&!a.metaKey)break;this.activateAll();a.preventDefault();break;case 9:case 13:if(this.$input.data("ui-autocomplete")&&this.$input.data("ui-autocomplete").menu.element.find("li:has(a.ui-state-focus), li.ui-state-focus").length)break;if(this.$input.hasClass("tt-input")&&this.$wrapper.find(".tt-cursor").length)break;if(this.$input.hasClass("tt-input")&&this.$wrapper.find(".tt-hint").val()&&this.$wrapper.find(".tt-hint").val().length)break;if(this.$input.is(document.activeElement)&&
this.$input.val().length||this.$input.data("edit"))return this.createTokensFromInput(a,this.$input.data("edit"));if(13===a.keyCode){if(!this.$copyHelper.is(document.activeElement)||1!==this.$wrapper.find(".token.active").length)break;if(!d.options.allowEditing)break;this.edit(this.$wrapper.find(".token.active"))}}this.lastKeyDown=a.keyCode}},keypress:function(a){if(-1!==c.inArray(a.which,this._triggerKeys)&&this.$input.is(document.activeElement))return this.$input.val()&&this.createTokensFromInput(a),
!1},keyup:function(a){this.preventInputFocus=!1;if(this.focused){switch(a.keyCode){case 8:if(this.$input.is(document.activeElement)){if(this.$input.val().length||this.lastInputValue.length&&8===this.lastKeyDown)break;this.preventDeactivation=!0;var b=this.$input.hasClass("tt-input")?this.$input.parent().prevAll(".token:first"):this.$input.prevAll(".token:first");if(!b.length)break;this.activate(b)}else this.remove(a);break;case 46:this.remove(a,"next")}this.lastKeyUp=a.keyCode}},focus:function(a){this.focused=
!0;this.$wrapper.addClass("focus");this.$input.is(document.activeElement)&&(this.$wrapper.find(".active").removeClass("active"),this.$firstActiveToken=null,this.options.showAutocompleteOnFocus&&this.search())},blur:function(a){this.focused=!1;this.$wrapper.removeClass("focus");this.preventDeactivation||this.$element.is(document.activeElement)||(this.$wrapper.find(".active").removeClass("active"),this.$firstActiveToken=null);!this.preventCreateTokens&&(this.$input.data("edit")&&!this.$input.is(document.activeElement)||
this.options.createTokensOnBlur)&&this.createTokensFromInput(a);this.preventCreateTokens=this.preventDeactivation=!1},paste:function(a){var b=this;b.options.allowPasting&&setTimeout(function(){b.createTokensFromInput(a)},1)},change:function(a){"tokenfield"!==a.initiator&&this.setTokens(this.$element.val())},createTokensFromInput:function(a,b){if(!(this.$input.val().length<this.options.minLength)){var c=this.getTokensList();this.setTokens(this.$input.val(),!0);if(c==this.getTokensList()&&this.$input.val().length)return!1;
this.$input.hasClass("tt-input")?this.$input.typeahead("val",""):this.$input.val("");this.$input.data("edit")&&this.unedit(b);return!1}},next:function(a){if(a){var b=this.$wrapper.find(".active:first");if(b&&this.$firstActiveToken&&b.index()<this.$firstActiveToken.index())return this.deactivate(b)}b=this.$wrapper.find(".active:last").nextAll(".token:first");b.length?this.activate(b,a):this.$input.focus()},prev:function(a){if(a){var b=this.$wrapper.find(".active:last");if(b&&this.$firstActiveToken&&
b.index()>this.$firstActiveToken.index())return this.deactivate(b)}b=this.$wrapper.find(".active:first").prevAll(".token:first");b.length||(b=this.$wrapper.find(".token:first"));b.length||a?this.activate(b,a):this.$input.focus()},activate:function(a,b,e,d){if(a){"undefined"===typeof d&&(d=!0);e&&(b=!0);this.$copyHelper.focus();b||(this.$wrapper.find(".active").removeClass("active"),d?this.$firstActiveToken=a:delete this.$firstActiveToken);if(e&&this.$firstActiveToken){b=this.$firstActiveToken.index()-
2;e=a.index()-2;var f=this;this.$wrapper.find(".token").slice(Math.min(b,e)+1,Math.max(b,e)).each(function(){f.activate(c(this),!0)})}a.addClass("active");this.$copyHelper.val(this.getTokensList(null,null,!0)).select()}},activateAll:function(){var a=this;this.$wrapper.find(".token").each(function(b){a.activate(c(this),0!==b,!1,!1)})},deactivate:function(a){a&&(a.removeClass("active"),this.$copyHelper.val(this.getTokensList(null,null,!0)).select())},toggle:function(a){a&&(a.toggleClass("active"),this.$copyHelper.val(this.getTokensList(null,
null,!0)).select())},edit:function(a){if(a){var b=a.data("attrs"),e={attrs:b,relatedTarget:a.get(0)},d=c.Event("tokenfield:edittoken",e);this.$element.trigger(d);if(!d.isDefaultPrevented()){a.find(".token-label").text(b.value);var d=a.outerWidth(),f=this.$input.hasClass("tt-input")?this.$input.parent():this.$input;a.replaceWith(f);this.preventCreateTokens=!0;this.$input.val(b.value).select().data("edit",!0).width(d);this.update();this.$element.trigger(c.Event("tokenfield:editedtoken",e))}}},unedit:function(a){(this.$input.hasClass("tt-input")?
this.$input.parent():this.$input).appendTo(this.$wrapper);this.$input.data("edit",!1);this.$mirror.text("");this.update();if(a){var b=this;setTimeout(function(){b.$input.focus()},1)}},remove:function(a,b){if(!(this.$input.is(document.activeElement)||this._disabled||this._readonly)){var e="click"===a.type?c(a.target).closest(".token"):this.$wrapper.find(".token.active");if("click"!==a.type&&(b||(b="prev"),this[b](),"prev"===b))var d=0===e.first().prevAll(".token:first").length;var f={attrs:this.getTokenData(e),
relatedTarget:e.get(0)},k=c.Event("tokenfield:removetoken",f);this.$element.trigger(k);k.isDefaultPrevented()||(f=c.Event("tokenfield:removedtoken",f),k=c.Event("change",{initiator:"tokenfield"}),e.remove(),this.$element.val(this.getTokensList()).trigger(f).trigger(k),this.$wrapper.find(".token").length&&"click"!==a.type&&!d||this.$input.focus(),this.$input.css("width",this.options.minWidth+"px"),this.update(),a.preventDefault(),a.stopPropagation())}},update:function(a){a=this.$input.val();var b=
parseInt(this.$input.css("padding-left"),10),c=parseInt(this.$input.css("padding-right"),10),b=b+c;if(this.$input.data("edit")){if(a||(a=this.$input.prop("placeholder")),a!==this.$mirror.text()){this.$mirror.text(a);a=this.$mirror.width()+10;if(a>this.$wrapper.width())return this.$input.width(this.$wrapper.width());this.$input.width(a);this.$hint&&this.$hint.width(a)}}else a="rtl"===this.textDirection?this.$input.offset().left+this.$input.outerWidth()-this.$wrapper.offset().left-parseInt(this.$wrapper.css("padding-left"),
10)-b-1:this.$wrapper.offset().left+this.$wrapper.width()+parseInt(this.$wrapper.css("padding-left"),10)-this.$input.offset().left-b,isNaN(a)?this.$input.width("100%"):this.$input.width(a),this.$hint&&(isNaN(a)?this.$hint.width("100%"):this.$hint.width(a))},focusInput:function(a){if(!(c(a.target).closest(".token").length||c(a.target).closest(".token-input").length||c(a.target).closest(".tt-dropdown-menu").length)){var b=this;setTimeout(function(){b.$input.focus()},0)}},search:function(){this.$input.data("ui-autocomplete")&&
this.$input.autocomplete("search")},disable:function(){this.setProperty("disabled",!0)},enable:function(){this.setProperty("disabled",!1)},readonly:function(){this.setProperty("readonly",!0)},writeable:function(){this.setProperty("readonly",!1)},setProperty:function(a,b){this["_"+a]=b;this.$input.prop(a,b);this.$element.prop(a,b);this.$wrapper[b?"addClass":"removeClass"](a)},destroy:function(){this.$element.val(this.getTokensList());this.$element.css(this.$element.data("original-styles"));this.$element.prop("tabindex",
this.$element.data("original-tabindex"));var a=c('label[for="'+this.$input.prop("id")+'"]');a.length&&a.prop("for",this.$element.prop("id"));this.$element.insertBefore(this.$wrapper);this.$element.removeData("original-styles").removeData("original-tabindex").removeData("bs.tokenfield");this.$wrapper.remove();this.$mirror.remove();return this.$element}};var n=c.fn.tokenfield;c.fn.tokenfield=function(a,b){var e,d=[];Array.prototype.push.apply(d,arguments);var f=this.each(function(){var f=c(this),g=
f.data("bs.tokenfield"),h="object"==typeof a&&a;"string"===typeof a&&g&&g[a]?(d.shift(),e=g[a].apply(g,d)):g||"string"===typeof a||b||(f.data("bs.tokenfield",new l(this,h)),f.trigger("tokenfield:initialize"))});return"undefined"!==typeof e?e:f};c.fn.tokenfield.defaults={minWidth:60,minLength:0,allowEditing:!0,allowPasting:!0,limit:0,autocomplete:{},typeahead:{},showAutocompleteOnFocus:!1,createTokensOnBlur:!1,delimiter:",",beautify:!0,inputType:"text"};c.fn.tokenfield.Constructor=l;c.fn.tokenfield.noConflict=
function(){c.fn.tokenfield=n;return this};return l});
